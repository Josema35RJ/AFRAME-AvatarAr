<!DOCTYPE html>
<html>
  <head>
    <title>Escena AR con Avatar</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script>
      AFRAME.registerComponent('place-on-surface', {
        init: function () {
          const el = this.el;
          const scene = this.el.sceneEl;

          // Verificar WebXR y forzar AR con manejo de permisos
          if ('xr' in navigator) {
            console.log('WebXR detectado, intentando iniciar AR');
            navigator.permissions.query({ name: 'camera' }).then(permission => {
              if (permission.state === 'granted') {
                scene.enterAR().then(() => {
                  console.log('Modo AR activado con éxito');
                  el.setAttribute('visible', false); // Ocultar hasta detectar superficie
                }).catch(err => {
                  console.error('Error al entrar en AR:', err.message);
                });
              } else {
                console.error('Permiso de cámara no otorgado, revisa los ajustes');
                alert('Por favor, otorga permiso a la cámara en los ajustes del navegador.');
              }
            });
          } else {
            console.error('WebXR no soportado');
            alert('Tu navegador no soporta WebXR. Usa Chrome en Android.');
          }

          scene.addEventListener('enter-ar', () => {
            console.log('Modo AR iniciado');
          });

          scene.addEventListener('exit-ar', () => {
            el.setAttribute('visible', false);
            console.log('Saliendo de modo AR');
          });
        },
        tick: function () {
          if (this.el.sceneEl.is('ar-mode')) {
            const hitTest = this.el.sceneEl.systems['webxr'].hitTestSource;
            if (hitTest) {
              hitTest.getHitTestResults().then(results => {
                if (results.length > 0) {
                  const hit = results[0];
                  const pose = hit.getPose(this.el.sceneEl.renderer.xr.getReferenceSpace());
                  if (pose) {
                    this.el.setAttribute('position', {
                      x: pose.transform.position.x,
                      y: pose.transform.position.y + 0.5,
                      z: pose.transform.position.z
                    });
                    this.el.setAttribute('visible', true);
                  }
                } else {
                  this.el.setAttribute('visible', false);
                }
              });
            }
          }
        }
      });
    </script>
  </head>
  <body>
    <a-scene
      webxr="requiredFeatures: hit-test"
      vr-mode-ui="enabled: false"
      renderer="colorManagement: true"
    >
      <a-assets>
        <a-asset-item id="avatar" src="https://cdn.jsdelivr.net/gh/Josema35RJ/Avatar@main/3dpea.com_Salute.glb"></a-asset-item>
      </a-assets>

      <a-entity
        gltf-model="#avatar"
        place-on-surface
        rotation="0 0 0"
        scale="1.2 1.2 1.2"
        animation-mixer
      ></a-entity>

      <a-entity camera position="0 1.6 0.5" look-controls></a-entity>

      <a-entity light="type: ambient; intensity: 0.6"></a-entity>
    </a-scene>
  </body>
</html>
