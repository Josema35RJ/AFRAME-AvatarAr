<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <title>Avatar AR</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

    <script>
      AFRAME.registerComponent('place-on-surface', {
        init: function () {
          // Inicialmente oculto hasta detectar superficie
          this.el.setAttribute('visible', false);
        },
        tick: function () {
          const scene = this.el.sceneEl;

          // Solo activo en modo AR
          if (!scene.is('ar-mode')) return;

          const xrSystem = scene.systems.webxr;
          if (!xrSystem.hitTestSource) return;

          const hitTestResults = xrSystem.hitTestSource.getHitTestResults();
          if (!hitTestResults || hitTestResults.length === 0) {
            this.el.setAttribute('visible', false);
            return;
          }

          const hit = hitTestResults[0];
          const pose = hit.getPose(scene.renderer.xr.getReferenceSpace());
          if (pose) {
            this.el.setAttribute('position', {
              x: pose.transform.position.x,
              y: pose.transform.position.y,
              z: pose.transform.position.z
            });
            this.el.setAttribute('visible', true);
          }
        }
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden;">
    <a-scene
      xrweb="requiredFeatures: hit-test"
      ar-mode-ui="enabled: true"
      renderer="colorManagement: true"
    >
      <a-assets>
        <a-asset-item id="avatar" src="https://cdn.jsdelivr.net/gh/Josema35RJ/Avatar@main/3dpea.com_Salute.glb"></a-asset-item>
      </a-assets>

      <!-- Avatar que se colocará sobre la superficie -->
      <a-entity
        gltf-model="#avatar"
        place-on-surface
        scale="1.2 1.2 1.2"
        rotation="0 0 0"
        position="0 -10 0"
        animation-mixer
      ></a-entity>

      <!-- Cámara -->
      <a-entity camera position="0 1.6 0.5" look-controls></a-entity>

      <!-- Luz ambiental -->
      <a-entity light="type: ambient; intensity: 0.8"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="0 4 0"></a-entity>
    </a-scene>
  </body>
</html>
