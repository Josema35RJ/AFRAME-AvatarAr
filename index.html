<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Avatar AR Funcional</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script>
    AFRAME.registerComponent('place-on-hit', {
      init: function () {
        const el = this.el;
        // Oculto al inicio
        el.setAttribute('visible', false);

        const scene = el.sceneEl;

        // Listener para hit-test AR
        scene.addEventListener('ar-hit-test', (event) => {
          const pose = event.detail.pose;
          if (!pose) return;

          // Colocar avatar sobre la superficie detectada
          el.setAttribute('position', {
            x: pose.transform.position.x,
            y: pose.transform.position.y,
            z: pose.transform.position.z
          });
          el.setAttribute('visible', true);
        });
      }
    });
  </script>
  <style>
    body { margin: 0; overflow: hidden; }
  </style>
</head>
<body>
  <a-scene
    xrweb="requiredFeatures: hit-test"
    ar-mode-ui="enabled: true"
    renderer="colorManagement: true"
  >
    <a-assets>
      <a-asset-item id="avatar" src="https://cdn.jsdelivr.net/gh/Josema35RJ/Avatar@main/3dpea.com_Salute.glb"></a-asset-item>
      <a-asset-item id="reticle" src="https://cdn.jsdelivr.net/gh/Josema35RJ/Avatar@main/reticle.glb"></a-asset-item>
    </a-assets>

    <!-- Guía visual para la superficie (reticle) -->
    <a-entity
      id="reticleEntity"
      gltf-model="#reticle"
      scale="0.2 0.2 0.2"
      position="0 -10 0"
    ></a-entity>

    <!-- Avatar animado -->
    <a-entity
      gltf-model="#avatar"
      place-on-hit
      scale="1.2 1.2 1.2"
      rotation="0 0 0"
      animation-mixer
      position="0 -10 0"
    ></a-entity>

    <!-- Cámara -->
    <a-entity camera position="0 1.6 0.5" look-controls></a-entity>

    <!-- Iluminación -->
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="0 4 0"></a-entity>
  </a-scene>

  <script>
    // Mover el reticle a la posición del hit-test
    const scene = document.querySelector('a-scene');
    const reticle = document.querySelector('#reticleEntity');

    scene.addEventListener('ar-hit-test', (event) => {
      const pose = event.detail.pose;
      if (!pose) return;
      reticle.setAttribute('position', {
        x: pose.transform.position.x,
        y: pose.transform.position.y,
        z: pose.transform.position.z
      });
      reticle.setAttribute('visible', true);
    });
  </script>
</body>
</html>

